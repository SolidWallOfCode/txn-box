#regex_map https://^(s|u|s[1-3]).yimg.com|^cdn.onesearch.com/un/     https://mrs-ymweather.mrs.yimg.com/
#want 99% of traffic to https://mrs-ymweather.mrs.yimg.com/
# and 1% of traffic to https://mysterio.yahoo.com
# and ramp up from there until 100% of traffic has shifted to mysterio

meta:
  version: "1.0"

  txn_box:
  - with: random<0-999>
    select:
    - lt: 950
      do:
      - apply-remap-rule:
      - remap-host: "example.three"
      - debug: "remapped: {...} to host {creq-host} with path {creq-path}"

sessions:
- protocol: [ ipv4, tcp ]
  transactions:
  - client-request:
      version: "1.1"
      scheme: "http"
      method: "GET"
      url: "/config/settings.yaml"
      headers:
        fields:
        - [ Host, example.one ]
    proxy-request:
      version: "1.1"
      scheme: "http"
      method: "GET"
      url: "/settings.yaml"
      headers:
        fields:
        - [ Host, example.one ]
    server-response:
      status: 200
      reason: OK
      content:
        size: 100
      headers:
        fields:
        - [ Content-Type, text/html ]
        - [ Content-Length, 100 ]
    proxy-response:
      status: 200

  - client-request:
      version: "1.1"
      scheme: "http"
      method: "GET"
      url: "/config/settings.yaml"
      headers:
        fields:
        - [ Host, example.two ]
    proxy-request:
      version: "1.1"
      scheme: "http"
      method: "GET"
      url: "/settings.yaml"
      headers:
        fields:
        - [ Host, example.two ]
    server-response:
      status: 200
      reason: OK
      content:
        size: 200
      headers:
        fields:
        - [ Content-Type, text/html ]
        - [ Content-Length, 200 ]
    proxy-response:
      status: 200

  - client-request:
      version: "1.1"
      scheme: "http"
      method: "GET"
      url: "/config/settings.yaml"
      headers:
        fields:
        - [ Host, example.three ]
    proxy-request:
      version: "1.1"
      scheme: "http"
      method: "GET"
      url: "/settings.yaml"
      headers:
        fields:
        - [ Host, example.three ]
    server-response:
      status: 200
      reason: OK
      content:
        size: 300
      headers:
        fields:
        - [ Content-Type, text/html ]
        - [ Content-Length, 300 ]
    proxy-response:
      status: 200
