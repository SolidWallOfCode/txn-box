# 1) set the Expect-CT
# 2) Explicitly turn on XSS protection (usually already present)
# 3) set X-XSS-Protection to prevent XSS attacks.

txn_box:
- when: creq
  do:
  # default Expect-CT policy.
  - when: creq
    do:
    - with: cssn-proto<tls>
      select:
      - prefix: "tls"
        do:
        - with: creq-host
          select:
          - match: "u.yimg.com"
            do:
            - var<ct-policy>: "enforce" # set Expect-CT policy.
          - do:
              var<ct-policy>: "report-uri=\"http://csp.yahoo.com/beacon/csp?src=yahoocom-expect-ct-report-only\""
  - when: creq
    do:
    - with: creq-host
      select:
      - tld: "yimg.com"   # yimg.com or any subdomain
        do:
        - creq-field<Cookie>: NULL

- when: ursp
  do:
  - ursp-field<Set-Cookie>: # filter out any Set-Cookie field for yimg.com
    - ursp-field<Set-Cookie>
    - filter:
      - none-of:
        - rxp<nc>: "domain=(?:[^=]*[.])?yimg[.]com"

- when: prsp
  do:
  # set a referrer policy if not already present.
  - prsp-field<Referrer-Policy>: [ prsp-field<Referrer-Policy>, { else: "no-referrer-when-downgrade" } ]
  # For proxy response, fix up the cross site fields if it's TLS.
  - with: cssn-proto<tls>
    select:
    - prefix: "tls"
      do:
      - prsp-field<Expect-CT>: "max-age=31536000, {var<ct-policy>}"
      - prsp-field<X-XSS-Protection>: "1; mode=block"
      - prsp-field<X-Content-Type-Options>: "nosniff"
