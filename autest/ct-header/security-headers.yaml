meta:
  version: "1.0"

  # 1) set the Expect-CT
  # 2) Explicitly turn on XSS protection (usually already present)
  # 3) set X-XSS-Protection to prevent XSS attacks.

  txn_box:
  - when: creq
    do:
    # default Expect-CT policy.
    - when: creq
      do:
      - with: cssn-proto<tls>
        select:
        - prefix: "tls"
          do:
          - with: creq-host
            select:
            - match: "u.yimg.com"
              do:
              - var<ct-policy>: "enforce" # set Expect-CT policy.
            - do:
                var<ct-policy>: "report-uri=\"http://csp.yahoo.com/beacon/csp?src=yahoocom-expect-ct-report-only\""
    - when: creq
      do:
      - with: creq-host
        select:
        - tld: "yimg.com"   # yimg.com or any subdomain
          do:
          - creq-field<Cookie>: NULL

  - when: ursp
    do:
    - ursp-field<Set-Cookie>: # filter set-cookie fields
      - ursp-field<Set-Cookie> # get the current list
      - filter: # keep the ones
        - none-of: # that do *not* match
          - rxp<nc>: "domain=(?:[^=]*[.])?yimg[.]com" # this regex

  - when: prsp
    do:
    # set a referrer policy if not already present.
    - prsp-field<Referrer-Policy>: [ prsp-field<Referrer-Policy>, { else: "no-referrer-when-downgrade" } ]
    # For proxy response, fix up the cross site fields if it's TLS.
    - with: cssn-proto<tls>
      select:
      - prefix: "tls"
        do:
        - prsp-field<Expect-CT>: "max-age=31536000, {var<ct-policy>}"
        - prsp-field<X-XSS-Protection>: "1; mode=block"
        - prsp-field<X-Content-Type-Options>: "nosniff"

sessions:

- protocol: [ tcp ]
  transactions:

  - all: { headers: { fields:  [[ uuid, 1 ]]}}

    client-request:
      version: "1.1"
      scheme: "http"
      method: "GET"
      url: "http://example.one/config/settings.yaml"
      headers: { fields: [[ Host, example.one]]}

    proxy-request:
      method: GET

    server-response:
      status: 200
      reason: OK
      content: { size: 72 }
      headers:
        fields:
        - [ Content-Type, text/html ]
        - [ Content-Length, 72 ]

    proxy-response:
      status: 200
      headers:
        fields:
        - [ expect-ct, "", absent]

- protocol: [ tls ]
  transactions:

  - all: { headers: { fields: [[ uuid, 2 ]]}}

    client-request:
      version: "1.1"
      scheme: "http"
      method: "GET"
      url: "http://example.one/config/settings.yaml"
      headers: { fields: [[ Host, example.one ]]}

    proxy-request:
      method: GET

    server-response:
      status: 200
      reason: OK
      content: { size: 72 }
      headers:
        fields:
        - [ Content-Type, text/html ]
        - [ Content-Length, 72 ]

    proxy-response:
      status: 200
      headers:
        fields:
        - [ expect-ct, "max-age=31536000, report-uri=\"http://csp.yahoo.com/beacon/csp?src=yahoocom-expect-ct-report-only\"", equal]

  - all: { headers: { fields: [[ uuid, 3 ]]}}

    client-request:
      version: "1.1"
      scheme: "http"
      method: "GET"
      url: "http://u.yimg.com/config/settings.yaml"
      headers: { fields: [[ Host, u.yimg.com ]]}

    proxy-request:
      method: GET

    server-response:
      status: 200
      reason: OK
      content: { size: 72 }
      headers:
        fields:
        - [ Content-Type, text/html ]
        - [ Content-Length, 72 ]

    proxy-response:
      status: 200
      headers:
        fields:
        - [ expect-ct, "max-age=31536000, enforce", equal]

  - all: { headers: { fields: [[ uuid, 4 ]]}}

    client-request:
      version: "1.1"
      scheme: "http"
      method: "GET"
      url: "http://yimg.com/config/settings.yaml"
      headers: { fields: [[ Host, yimg.com ]]}

    proxy-request:
      method: GET

    server-response:
      status: 200
      reason: OK
      content: { size: 72 }
      headers:
        fields:
        - [ Content-Type, text/html ]
        - [ Content-Length, 72 ]

    proxy-response:
      status: 200
      headers:
        fields:
        - [ expect-ct, "max-age=31536000, report-uri=\"http://csp.yahoo.com/beacon/csp?src=yahoocom-expect-ct-report-only\"", equal]

- protocol: [ tcp ]
  transactions:

  - all: { headers: { fields: [[ uuid, 5 ]]}}
    client-request:
      version: "1.1"
      scheme: "http"
      method: "GET"
      url: "http://example.one/config/settings.yaml"
      headers:
        fields:
        - [ Host, example.one ]
        - [ Cookie, "V1=d=AQABBOwAKl4CEHhhMYGPgqPDtrDE-lZJ1EEFEgEBAQFSK14zXgAAAAAA_SMAAAcIfkkiXn6kwz8&S=AQAAAvbDdNlyRU0neZmPg97sQC8; A3=d=AQABBOwAKl4CEHhhMYGPgqPDtrDE-lZJ1EEFEgEBAQFSK14zXgAAAAAA_SMAAAcIfkkiXn6kwz8&S=AQAAAvbDdNlyRU0neZmPg97sQC8; GUC=AQEBAQFeK1JeM0If1wSb; A1S=d=AQABBOwAKl4CEHhhMYGPgqPDtrDE-lZJ1EEFEgEBAQFSK14zXgAAAAAA_SMAAAcIfkkiXn6kwz8&S=AQAAAvbDdNlyRU0neZmPg97sQC8; uvts=24ce92ce-6bef-4940-5676-ccce503e26f6; APID=UP53275975-3e1e-11ea-b6a9-0e860b33a8b3; cmp=t=1579898053&j=0; apeaf=userintent%3D%257B%2522tooltipViews%2522%253A3%257D; APIDTS=1579898054; B=3vgt4fpf24ibu&b=3&s=o9" ]

    proxy-request:
      method: "GET"
      headers:
        fields:
        - [ Cookie, "V1=d=AQABBOwAKl4CEHhhMYGPgqPDtrDE-lZJ1EEFEgEBAQFSK14zXgAAAAAA_SMAAAcIfkkiXn6kwz8&S=AQAAAvbDdNlyRU0neZmPg97sQC8; A3=d=AQABBOwAKl4CEHhhMYGPgqPDtrDE-lZJ1EEFEgEBAQFSK14zXgAAAAAA_SMAAAcIfkkiXn6kwz8&S=AQAAAvbDdNlyRU0neZmPg97sQC8; GUC=AQEBAQFeK1JeM0If1wSb; A1S=d=AQABBOwAKl4CEHhhMYGPgqPDtrDE-lZJ1EEFEgEBAQFSK14zXgAAAAAA_SMAAAcIfkkiXn6kwz8&S=AQAAAvbDdNlyRU0neZmPg97sQC8; uvts=24ce92ce-6bef-4940-5676-ccce503e26f6; APID=UP53275975-3e1e-11ea-b6a9-0e860b33a8b3; cmp=t=1579898053&j=0; apeaf=userintent%3D%257B%2522tooltipViews%2522%253A3%257D; APIDTS=1579898054; B=3vgt4fpf24ibu&b=3&s=o9", equal ]

    server-response:
      status: 200
      reason: OK
      content: { size: 84 }
      headers:
        fields: &srv-response-fields
        - [ Content-Type, text/html ]
        - [ Content-Length, 84 ]

    proxy-response:
      status: 200

  - all: { headers: { fields: [[ uuid, 6 ]]}}
    client-request:
      version: "1.1"
      scheme: "http"
      method: "GET"
      url: "http://s.yimg.com/fancy-picture.jpg"
      headers:
        fields:
        - [ Host, s.yimg.com ]
        - [ Cookie, "V1=d=AQABBOwAKl4CEHhhMYGPgqPDtrDE-lZJ1EEFEgEBAQFSK14zXgAAAAAA_SMAAAcIfkkiXn6kwz8&S=AQAAAvbDdNlyRU0neZmPg97sQC8; A3=d=AQABBOwAKl4CEHhhMYGPgqPDtrDE-lZJ1EEFEgEBAQFSK14zXgAAAAAA_SMAAAcIfkkiXn6kwz8&S=AQAAAvbDdNlyRU0neZmPg97sQC8; GUC=AQEBAQFeK1JeM0If1wSb; A1S=d=AQABBOwAKl4CEHhhMYGPgqPDtrDE-lZJ1EEFEgEBAQFSK14zXgAAAAAA_SMAAAcIfkkiXn6kwz8&S=AQAAAvbDdNlyRU0neZmPg97sQC8; uvts=24ce92ce-6bef-4940-5676-ccce503e26f6; APID=UP53275975-3e1e-11ea-b6a9-0e860b33a8b3; cmp=t=1579898053&j=0; apeaf=userintent%3D%257B%2522tooltipViews%2522%253A3%257D; APIDTS=1579898054; B=3vgt4fpf24ibu&b=3&s=o9" ]

    proxy-request:
      method: "GET"
      headers:
        fields:
        - [ Cookie, "", absent ]

    server-response:
      status: 200
      reason: OK
      content: { size: 84 }
      headers:
        fields: *srv-response-fields

    proxy-response:
      status: 200

  - all: { headers: { fields: [[ uuid, 7 ]]}}
    client-request:
      version: "1.1"
      scheme: "http"
      method: "GET"
      url: "http://s.yimg.com/fancy-picture.jpg"
      headers:
        fields:
        - [ Host, s.yimg.com ]

    proxy-request:
      method: "GET"
      headers:
        fields:

    server-response:
      status: 200
      reason: OK
      content: { size: 84 }
      headers:
        fields:
        - [ Content-Type, text/html ]
        - [ Content-Length, 84 ]
        - [ set-cookie, "A1=d=AQABBO; Max-Age=31557600; Domain=.yahoo.com; Path=/; SameSite=Lax; Secure; HttpOnly" ]

    proxy-response:
      status: 200
      headers:
        fields:
        - [ set-cookie, "A1=d=AQABBO; Max-Age=31557600; Domain=.yahoo.com; Path=/; SameSite=Lax; Secure; HttpOnly", equal ]

  - all: { headers: { fields: [[ uuid, 8 ]]}}
    client-request:
      version: "1.1"
      scheme: "http"
      method: "GET"
      url: "http://s.yimg.com/fancy-picture.jpg"
      headers:
        fields:
        - [ Host, s.yimg.com ]

    proxy-request:
      method: "GET"
      headers:
        fields:

    server-response:
      status: 200
      reason: OK
      content: { size: 84 }
      headers:
        fields:
        - [ Content-Type, text/html ]
        - [ Content-Length, 84 ]
        - [ set-cookie, "A1=d=AQABBO; Max-Age=31557600; Domain=.yimg.com; Path=/; SameSite=Lax; Secure; HttpOnly" ]

    proxy-response:
      status: 200
      headers:
        fields:
        - [ set-cookie, "", absent ]

  - all: { headers: { fields: [[ uuid, 9 ]]}}
    client-request:
      version: "1.1"
      scheme: "http"
      method: "GET"
      url: "http://s.yimg.com/fancy-picture.jpg"
      headers:
        fields:
        - [ Host, s.yimg.com ]

    proxy-request:
      method: "GET"
      headers:
        fields:

    server-response:
      status: 200
      reason: OK
      content: { size: 84 }
      headers:
        fields:
        - [ Content-Type, text/html ]
        - [ Content-Length, 84 ]
        - [ set-cookie, "A1=d=AQABBO; Max-Age=31557600; Domain=.yimg.com; Path=/; SameSite=Lax; Secure; HttpOnly" ]
        - [ set-cookie, "A1=d=AQABBO; Max-Age=31557600; Domain=.yahoo.com; Path=/; SameSite=Lax; Secure; HttpOnly" ]

    proxy-response:
      status: 200
      # Should only get one set-cookie here, but can't check for that in this version of Proxy Verifier.
