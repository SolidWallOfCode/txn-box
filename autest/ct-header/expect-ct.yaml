meta:
  verion: "1.0"

  txn_box:
  - when: creq
    do:
    - with: cssn-proto<tls>
      select:
      - prefix: "tls"
        do:
        - when: prsp
          do:
            prsp-field<Expect-CT>: "max-age=31536000, {var<ct-policy>}"
        - with: creq-host
          select:
          - match: "u.yimg.com"
            do:
            - var<ct-policy>: "enforce" # set Expect-CT policy.
          - do:
              var<ct-policy>: "report-uri=\"http://csp.yahoo.com/beacon/csp?src=yahoocom-expect-ct-report-only\""

sessions:
- protocol: [ ipv4, tcp ]

  transactions:

  - all: { headers: { fields:  [[ uuid, 1 ]]}}

    client-request:
      version: "1.1"
      scheme: "http"
      method: "GET"
      url: "http://example.one/config/settings.yaml"
      headers: { fields: [[ Host, example.one]]}

    proxy-request:
      method: GET

    server-response:
      status: 200
      reason: OK
      content: { size: 72 }
      headers:
        fields:
        - [ Content-Type, text/html ]
        - [ Content-Length, 72 ]

    proxy-response:
      status: 200
      headers:
        fields:
        - [ expect-ct, "", absent]

- protocol: [ tls ]

  transactions:

  - all: { headers: { fields: [[ uuid, 2 ]]}}

    client-request:
      version: "1.1"
      scheme: "http"
      method: "GET"
      url: "http://example.one/config/settings.yaml"
      headers: { fields: [[ Host, example.one ]]}

    proxy-request:
      method: GET

    server-response:
      status: 200
      reason: OK
      content: { size: 72 }
      headers:
        fields:
        - [ Content-Type, text/html ]
        - [ Content-Length, 72 ]

    proxy-response:
      status: 200
      headers:
        fields:
        - [ expect-ct, "max-age=31536000, report-uri=\"http://csp.yahoo.com/beacon/csp?src=yahoocom-expect-ct-report-only\"", equal]

  - all: { headers: { fields: [[ uuid, 3 ]]}}

    client-request:
      version: "1.1"
      scheme: "http"
      method: "GET"
      url: "http://u.yimg.com/config/settings.yaml"
      headers: { fields: [[ Host, u.yimg.com ]]}

    proxy-request:
      method: GET

    server-response:
      status: 200
      reason: OK
      content: { size: 72 }
      headers:
        fields:
        - [ Content-Type, text/html ]
        - [ Content-Length, 72 ]

    proxy-response:
      status: 200
      headers:
        fields:
        - [ expect-ct, "max-age=31536000, enforce", equal]

  - all: { headers: { fields: [[ uuid, 4 ]]}}

    client-request:
      version: "1.1"
      scheme: "http"
      method: "GET"
      url: "http://yimg.com/config/settings.yaml"
      headers: { fields: [[ Host, yimg.com ]]}

    proxy-request:
      method: GET

    server-response:
      status: 200
      reason: OK
      content: { size: 72 }
      headers:
        fields:
        - [ Content-Type, text/html ]
        - [ Content-Length, 72 ]

    proxy-response:
      status: 200
      headers:
        fields:
        - [ expect-ct, "max-age=31536000, report-uri=\"http://csp.yahoo.com/beacon/csp?src=yahoocom-expect-ct-report-only\"", equal]
