{
  "$schema": "https://github.com/solidwallofcode/schema/txn_box.schema.json",
  "title": "Transaction Box Configuratoin",
  "description": "Schema for Transaction Box configuration.",
  "type": "object",
  "properties": {
    "txn_box": {
      "$ref": "#/definitions/txn_box/directive_group"
    },
    "version": {
      "type": "string",
      "description": "Configuration format version."
    }
  },
  "definitions": {
    "txn_box": {
      "directive_group": {
        "description": "Directives.",
        "anyOf": [
          {
            "$ref": "#/definitions/txn_box/directive_list"
          },
          {
            "$ref": "#/definitions/txn_box/directive"
          }
        ]
      },
      "string_group": {
        "description": "List of or a single string",
        "anyOf": [
          { "type": "stirng" },
          {
            "type": "array",
            "minItems": 1,
            "items": { "type": "stirng" }
          }
        ]
      },
      "directive_list": {
        "description": "List of directivs.",
        "type": "array",
        "minItems": 1,
        "items": {
          "$ref": "#/definitions/txn_box/directive"
        }
      },
      "directive": {
        "description": "Directive.",
        "anyOf": [
          { "$ref": "#/definitios/txn_box/selection" },
          { "$ref": "#/definitions/txn_box/action" }
        ]
      },
      "action": {
        "Description": "Action.",
        "anyOf": [
          { "$ref": "#/definitions/txn_box/action_rewrite_url" }
          ]
      },
      "action_rewrite_url": {
        "description": "Rewrite the proxy request URL.",
        "type": "object",
        "properties": {
          "rewrite-url": {
            "description": "Extractor string for the new URL.",
            "type": "string"
          }
        },
        "required": [ "rewrite_url" ]
      },
      "selection": {
        "description": "Selection.",
        "type": "object",
        "properties": {
          "with": { "$ref": "#/definitions/txn_box/extractor" },
          "select": { "$ref": "#/definitions/txn_box/selection_case" }
        }
      },
      "extractor": {
        "anyOf": [
          { "$ref": "#/definitions/txn_box/extraction_string" },
          { "$ref": "#/definitions/txn_box/extraction_with_modifiers" }
          ]
      },,
      "extraction_string": {
        "description": "Format string for Feature extraction.",
        "type": "string"
      },
      "extraction_with_modifiers": {
        "description": "Extraction with modifiers.",
        "type": "array",
        "minItems": 2,
        "items": [ { "$ref": "#/definitions/txn_box/extraction_string" } ],
        "additionalItems": { "$ref": "#/definitions/txn_box/extraction_modifier" }
      },
      "extraction_modifier_hash": {
        "description": "Hashing Modifier for feature extraction.",
        "type": "object",
        "properties": {
          "hash": {
            "description": "Hash the extracted feature.",
            "type": "object",
            "properties": {
              "hash": {
                "description": "# of buckets for the hash output.",
                "type": "number"
              },
              "required": [
                "hash"
              ]
            }
          }
        },
        "extraction_modifier": {
          "description": "Feature extraction modifier",
          "anyOf": [
            {
              "$ref": "#/definitions/txn_box/extraction_modifier_hash"
            }
          ]
        },
        "selection_switch": {
          "description": "The cases for a selection.",
          "anyOf": [
            {
              "$ref": "#/definitions/txn_box/case"
            },
            {
              "$ref": "#/definitions/txn_box/case_list"
            }
          ]
        },
        "case_list": {
          "description": "List of selection cases",
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/definitions/txn_box/case" }
        },
        "case": {
          "description": "A specific selection case / comparison operator.",
          "anyOf": [
            { "$ref": "#/definitions/txn_box/case_match" },
            { "$ref": "#/definitions/txn_box/case_suffix" }
          ]
        },
        "case_match": {
          "description": "A specific selection to match.",
          "type": "object",
          "properties": {
            "match": { "$ref": "#/definitions/txn_box/string_group" },
            "do": { "$ref": "#/definitions/txn_box/directive_group" }
          }
        },
        "case_suffix": {
          "description": "A specific suffix to match.",
          "type": "object",
          "properties": {
            "suffix": { "$ref": "#/definitions/txn_box/string_group" },
            "do": { "$ref": "#/definitions/txn_box/directive_group" }
          }
        }
      }
    }
  }
}
